{{- $host := default "https://cusdis.com" .Site.Params.comments.cusdis.host -}}

<head>
    <style>
        /* Inline custom CSS to match the site's design */
        #cusdis_thread {
            background-color: var(--card-background);  /* Match background color */
            border-radius: var(--card-border-radius);  /* Match border radius */
            box-shadow: var(--shadow-l1);  /* Match shadow */
            padding: var(--card-padding);  /* Match padding */
            width: 100%;
        }

        #cusdis_thread iframe {
            width: 100% !important;
            border-radius: var(--card-border-radius);  /* Match iframe border radius */
            background-color: var(--card-background);  /* Match iframe background */
        }
    </style>
</head>

<div id="cusdis_thread"
    data-host="{{ $host }}"
    data-app-id="{{ .Site.Params.comments.cusdis.id }}"
    data-page-id="{{ .File.UniqueID }}"
    data-page-url="{{ .Permalink }}"
    data-page-title="{{ .Title }}"></div>

<script async defer src="{{ $host }}/js/cusdis.es.js"></script>

<script>
    // Function to dynamically apply styles to the iframe content
    function applyCustomStylesToIframe() {
        const iframe = document.querySelector('#cusdis_thread iframe');
        if (iframe && iframe.contentWindow) {
            const iframeDoc = iframe.contentWindow.document;

            if (iframeDoc && iframeDoc.body) {
                iframeDoc.body.style.backgroundColor = "var(--card-background)"; // Apply the background color
                iframeDoc.body.style.color = "var(--text-color)"; // Apply the text color
                
                // Optionally add a style tag for advanced customizations
                const style = iframeDoc.createElement('style');
                style.textContent = `
                    /* Additional custom styles */
                    .cusdis-comment, .cusdis-header {
                        background-color: var(--card-background) !important;
                        color: var(--text-color) !important;
                        border-radius: var(--card-border-radius);
                        box-shadow: var(--shadow-l1);
                    }
                `;
                iframeDoc.head.appendChild(style);
            }
        }
    }

    // Function to set the theme for Cusdis comments
    function setCusdisTheme(theme) {
        let cusdis = document.querySelector('#cusdis_thread iframe');
        if (cusdis) {
            window.CUSDIS.setTheme(theme);

            // Apply custom styles after setting the theme
            setTimeout(applyCustomStylesToIframe, 500); // Allow time for iframe content to load
        }
    }

    window.addEventListener('onColorSchemeChange', (e) => {
        setCusdisTheme(e.detail);
    });

    // Function to adjust the iframe height based on content
    function adjustCusdisIframeHeight() {
        let iframe = document.querySelector('#cusdis_thread iframe');
        if (iframe) {
            // Set initial height or an initial estimate
            iframe.style.height = '1500px';

            // Dynamically adjust height based on content
            setInterval(function() {
                if (iframe && iframe.contentWindow) {
                    let iframeDoc = iframe.contentWindow.document;
                    if (iframeDoc) {
                        let newHeight = iframeDoc.body.scrollHeight;
                        iframe.style.height = newHeight + 'px';  // Auto-resize height
                    }
                }
            }, 1000);  // Adjust every 1 second
        }
    }

    // Call functions once the page is fully loaded
    window.addEventListener('load', () => {
        adjustCusdisIframeHeight();
        setTimeout(applyCustomStylesToIframe, 1000); // Ensure the styles are applied after iframe loads
    });
</script>
